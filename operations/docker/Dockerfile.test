# MoodleClaude Test Runner Dockerfile
FROM python:3.11-slim

LABEL maintainer="MoodleClaude Team"
LABEL description="Test runner for MoodleClaude with all dependencies"

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# Install additional test dependencies
RUN pip install --no-cache-dir \
    pytest \
    pytest-asyncio \
    pytest-cov \
    pytest-html \
    pytest-json-report \
    requests \
    aiohttp \
    psycopg2-binary \
    selenium \
    beautifulsoup4 \
    lxml

# Create directories for test results
RUN mkdir -p /app/test-results /app/logs /app/reports

# Copy test scripts
COPY tests/ /app/tests/
COPY tools/ /app/tools/
COPY src/ /app/src/
COPY config/ /app/config/
COPY operations/test/ /app/operations/test/

# Set Python path
ENV PYTHONPATH="/app"
ENV PYTHONUNBUFFERED=1

# Create non-root user for security
RUN useradd -m -u 1000 testuser && \
    chown -R testuser:testuser /app
USER testuser

# Default command runs all tests
CMD ["python", "/app/operations/test/run_comprehensive_tests.py"]