#!/bin/bash

# MoodleClaude Pre-Push Hook
# =========================
# Automatically runs smoke test before pushing to ensure code quality
# This hook prevents pushing if critical tests fail

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

echo -e "${PURPLE}üöÄ MoodleClaude Pre-Push Hook${NC}"
echo -e "${BLUE}Running smoke test before push...${NC}"
echo ""

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
SMOKE_TEST_SCRIPT="$REPO_ROOT/scripts/smoke_test.sh"

# Check if smoke test script exists
if [ ! -f "$SMOKE_TEST_SCRIPT" ]; then
    echo -e "${RED}‚ùå Smoke test script not found: $SMOKE_TEST_SCRIPT${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  Allowing push to continue, but please add smoke test script${NC}"
    exit 0
fi

# Make sure script is executable
chmod +x "$SMOKE_TEST_SCRIPT"

# Run the smoke test in quick mode
echo -e "${BLUE}üîç Running quick smoke test...${NC}"
if "$SMOKE_TEST_SCRIPT" --quick --skip-docker; then
    echo ""
    echo -e "${GREEN}‚úÖ Smoke test passed! Push is allowed to continue.${NC}"
    echo -e "${GREEN}üéâ Your code is ready for deployment!${NC}"
    exit 0
else
    echo ""
    echo -e "${RED}‚ùå Smoke test failed! Push is blocked.${NC}"
    echo -e "${RED}üí• Please fix the failing tests before pushing.${NC}"
    echo ""
    echo -e "${YELLOW}üìã To check what failed:${NC}"
    echo -e "${YELLOW}   ./scripts/smoke_test.sh --quick${NC}"
    echo ""
    echo -e "${YELLOW}üìä To view detailed report:${NC}"
    echo -e "${YELLOW}   open reports/smoke_test/smoke_test_report.html${NC}"
    echo ""
    echo -e "${YELLOW}üîß To push without running tests (not recommended):${NC}"
    echo -e "${YELLOW}   git push --no-verify${NC}"
    echo ""
    exit 1
fi